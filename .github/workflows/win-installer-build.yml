name: 'Windows Installer Builder'
on:
  workflow_dispatch:


jobs:
  ## duplicate from make-test.yml
  # Check hashes first
  check-hashes:
    runs-on: ubuntu-24.04
    timeout-minutes: 10
    name: Check hashes
    container:
      image: 'gnuradio/ci:fedora-42-3.10'
    steps:
    - name: Checkout project
      uses: actions/checkout@v4
      with:
        fetch-depth: 1
    - name: Add git repo to safe repos
      run: git config --global --add safe.directory ${GITHUB_WORKSPACE}
    - name: Run hash fixer on all binding files
      run: gr-utils/bindtool/scripts/binding-hash-hotfixer.zsh gr-*/python/*/bindings/*.cc gnuradio-runtime/python/gnuradio/gr/bindings/*.cc
    - name: get changed files
      run: >
          git --no-pager diff -z --name-only --
          > /tmp/hashdiff
          ; [[ ! -s /tmp/hashdiff ]] && exit 0
          ; sed -z 's;.*;::error file=&::Hash mismatch in &\n;' /tmp/hashdiff
          | tr -d '\0'
          ; exit -1

  # We continue checking C++ formatting. No one gets free CPU cycles if they
  # can't use clang-format.
  check-formatting:
    name: Check C++ Formatting
    runs-on: ubuntu-24.04
    timeout-minutes: 15
    steps:
    - uses: actions/checkout@v2
    - uses: DoozyX/clang-format-lint-action@v0.14
      with:
        source: '.'
        extensions: 'h,hpp,cpp,cc,cc.in'
        clangFormatVersion: 14
  check-python-formatting:
    name: Check Python Formatting
    runs-on: ubuntu-24.04
    timeout-minutes: 15
    steps:
    - uses: actions/checkout@v2
    - uses: quentinguidee/pep8-action@v1
      with:
        # -----------------------------------
        # UPDATE tox.ini when making changes!
        arguments: '--max-line-length=120 --ignore E265,E266,E275,E402,E501,E704,E712,E713,E714,E711,E721,E722,E741,W504,W605 --exclude *.yml.py'
        # -----------------------------------
  ## end duplication
  build-windows:
    # All of these shall depend on the formatting check (needs: check-formatting)
    needs: [check-hashes, check-formatting, check-python-formatting]
    runs-on: windows-latest
    name: MSVC
    defaults:
      run:
        shell: cmd
    steps:
    - name: Check environment
      run: |
        set
        dir %SystemDrive%
    - name: Download and install msbuild
      run: |
        powershell -NoProfile -ExecutionPolicy Bypass -Command ^
          Invoke-WebRequest "https://aka.ms/vs/17/release/vs_buildtools.exe" ^
          -OutFile "%TEMP%\vs_buildtools.exe" -UseBasicParsing
        "%TEMP%\vs_buildtools.exe"  --quiet --wait --norestart --noUpdateInstaller ^
          --add Microsoft.VisualStudio.Workload.VCTools ^
          --includeRecommended
        REM Accept exit code 3010 as success
        IF %ERRORLEVEL% EQU 3010 EXIT 0
    - name: Add msbuild to PATH
      uses: microsoft/setup-msbuild@v2
      with:
        msbuild-architecture: x64
        vs-version: 17.0
    - name: test
      run: set
    - uses: actions/checkout@v4
    - uses: actions/setup-python@v5
      id: cp312
      with:
         python-version: '3.12'
    - run: | 
         echo '${{ steps.cp312.outputs.python-version }}'
         ${{ steps.cp313.outputs.python-path }} -m pip install virtualenv
         ${{ steps.cp313.outputs.python-path }} -m venv %RUNNER_WORKSPACE%\py_venv
         set PY_VENV_PATH=%PY_VENV_PATH%
         call %PY_VENV_PATH%\Scripts\activate
         python -c "import sys;print(sys.path)"
         echo "PY_VENV_PATH=%PY_VENV_PATH%" >> %GITHUB_ENV%
         echo "PATH=%PATH%" >> %GITHUB_ENV%
         set GITHUB_WORKSPACE
#    - name: Install chocolatey
#      run: |
#        setx chocolateyVersion 1.4.0 /m
#        @"%SystemRoot%\System32\WindowsPowerShell\v1.0\powershell.exe" ^
#        -NoProfile -InputFormat None -ExecutionPolicy Bypass ^
#        -Command "[System.Net.ServicePointManager]::SecurityProtocol = 3072; iex ((New-Object System.Net.WebClient).DownloadString('https://chocolatey.org/install.ps1'))"
#        SET "PATH=%PATH%;%ALLUSERSPROFILE%\chocolatey\bin"
#        @rem choco install -y doxygen.install --version=1.9.1
#        choco install -y NSIS --version=3.10
#        choco install -y python3 --version=3.12.10
#        echo "working path=_%CD%_"
#        @rem assumed installation location in %RUNNER_TOOL_CACHE%
#        %RUNNER_TOOL_CACHE%\Python\3.12.10\x64\python.exe -VV
#        call %RUNNER_TOOL_CACHE%\Python\3.12.10\x64\python.exe -m pip install virtualenv
#        call %RUNNER_TOOL_CACHE%\Python\3.12.10\x64\python.exe -m venv %RUNNER_WORKSPACE%\py_venv
#        call %RUNNER_WORKSPACE%\py_venv\Scripts\activate
#        python -c "import sys;print(sys.path)"
#        set
    - name: Install C++ Pkg Mgr - Conan2 via pip
      run: |
        python -c "import sys;print(sys.path)"
        set PY_VENV_PATH
        %PY_VENV_PATH%\Scripts\activate
        python -m pip install conan
        conan version
#    - name: Clone C++ Pkg Mgr - Conan2
#    
    - uses: msys2/setup-msys2@v2
      id: msys2
      with:
        update: true
        MSYSTEM: ucrt64
    - run:
        echo MSYS2_LOCATION='${{ steps.msys2.outputs.msys2-location }}'
        echo "MSYS2_LOCATION=%MSYS2_LOCATION%" >> %GITHUB_ENV%
        set MSYSTEM
        echo "MSYSTEM=ucrt64" >> %GITHUB_ENV%
    #- env:
    #    MSYS2_LOCATION: ${{ steps.msys2.outputs.msys2-location }}
    #    MSYSTEM: ucrt64
    #  run: |
    #    echo Exporting environment variable MSYS2_LOCATION with value '%MSYS2_LOCATION%'
    #    echo "MSYS2_LOCATION=%MSYS2_LOCATION%" >> %GITHUB_ENV%
    - name: Clone GVSBuild (to build GTK)
      uses: actions/checkout@v4
      with:
        repository: 'https://github.com/wingtk/gvsbuild.git'
        ref: '09028ca09c3f7eef4d7fe935f79cacd2fbb4410f'
        path: gvsbuild
        fetch-depth: 2
    - run: |
        git checkout HEAD^
        set
    #
    #- name: Clone QT5
    - name: Checkout code
      uses: actions/checkout@v4
    - name: Check environment
      run: |
        echo working path=_%CD%_
        set MSYS2_LOCATION
        set MSYSTEM
        set PY_VENV_PATH
        dir %CD%
        dir %RUNNER_WORKSPACE%
        set

